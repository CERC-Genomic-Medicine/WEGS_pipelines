# WES+WGS Pipeline to merge WES and WGS BAM Files

## 1. Description

WES+WGS pipeline merges two WES and WGS BAM files and generate depth stats before and after merging the files.

### 1.1 Processes

1. `RenameSampleName`:

    To make sure that sample names are consistent across the read groups and also between the wes and wgs bam files.

2. `MergeAndMarkDuplicates`:

    Merge the wes and wgs bam files and mark duplicates.

3. `GenerateCramFromBam`:

    Convert the merged bam file to cram file. Provide the reference genome file used for the bam files.

4. `IndexCrams`:

    Index the cram files generated by the GenerateCramFromBam process.

5. `GenerateStatsBeforeMergeWes`:

    Genearate samtools stats for the wes bam file.

6. `GenerateStatsBeforeMergeWgs`:

    Genearate samtools stats for the wgs bam file.

7. `GenerateStatsAfterMerge`:

    Genearate samtools stats for the merged bam file.

8. `GenerateCustomStatsFlankingWes`:

    Genearate custom depth stats for flanking regions (+/- 10bp target regions) in the wes bam file.

9. `GenerateCustomStatsTargetWes`:

    Genearate custom depth stats for target regions in the wes bam file.

10. `GenerateCustomStatsFlankingMerged`:

    Genearate custom depth stats for flanking regions (+/- 10bp target regions) in the merged bam file.

11. `GenerateCustomStatsTargetMerged`:

    Genearate custom depth stats for target regions in the merged bam file.

12. `GenerateCustomStatsWgs`:

    Genearate custom depth stats  in the wes bam file.


## 2. Execute

1. Clone this repository to the directory where you will run the pipeline:
   ```
   git clone https://github.com/CERC-Genomic-Medicine/ExomePlus.git
   ```
2. Traverse to the folder `WES+WGS`

3. Create `InputBAMFiles.txt` file:
    ```
    <SampleName>\t<path\to\wes\bam\file>\t<path\to\wgs\bam\file>
    ```
4. Create `InputBEDFiles.txt` file:
    ```
    <TargetName>\t<path\to\target\bed\file>
    ```

5. Create `.genome` file:
    ```
    <chromosome>\t<size>
    ```   

6. Modify `nextflow.config` configuration file:
    * `bamsListPath` -- path to the InputBAMFiles.txt.
    * `bedsListPath` -- path to the InputBEDFiles.txt.
    * `bedGenomePath` -- path 
    * `refGenome` -- path to the reference genome file.
    * `resultFolder` -- path to save the output files
    * `projectDir` -- path to the project directory
    * `baseQuality` -- Minimum base quality (integer) filter for `samtools depth` tool.
    * `mappingQuality` -- Minimum mapping quality (integer) filter for `samtools depth` tool.

7. Run pipeline (Interactive SLURM job):
    ```
    salloc --time=12:00:00 --ntasks=1 --mem-per-cpu=16G
    module load nextflow
    module load samtools
    module load picard
    module load bedtools
    nextflow run MergeBAMsPipeline.nf -w ~/scratch/working_directory
    ```
8. Run pipeline (sbatch job):
    ```
    sbatch sbatch_job.sh
    ```
## 3. Troubleshoot

1. `Failed to submit process to grid scheduler for execution`
   ```
   nextflow run MergeBAMsPipeline.nf -w ~/scratch/work_directory -resume
   ```
   
2. `libnet.so: failed to map segment from shared object`, then try to increase the amount of memory in your `salloc` or `sbatch` job.
